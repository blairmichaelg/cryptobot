============================= test session starts =============================
platform win32 -- Python 3.14.2, pytest-9.0.2, pluggy-1.6.0 -- C:\Python314\python.exe
cachedir: .pytest_cache
rootdir: C:\Users\azureuser\Repositories\cryptobot
configfile: pytest.ini
plugins: asyncio-1.3.0, cov-7.0.0, mock-3.15.1
asyncio: mode=Mode.AUTO, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 21 items

tests/test_orchestrator.py::TestJob::test_job_creation PASSED            [  4%]
tests/test_orchestrator.py::TestJob::test_job_ordering_by_priority PASSED [  9%]
tests/test_orchestrator.py::TestJob::test_job_ordering_by_next_run_when_priority_equal PASSED [ 14%]
tests/test_orchestrator.py::TestJob::test_job_default_retry_count PASSED [ 19%]
tests/test_orchestrator.py::TestJobScheduler::test_scheduler_initialization PASSED [ 23%]
tests/test_orchestrator.py::TestJobScheduler::test_add_job PASSED        [ 28%]
tests/test_orchestrator.py::TestJobScheduler::test_run_job_wrapper_success PASSED [ 33%]
tests/test_orchestrator.py::TestJobScheduler::test_run_job_wrapper_error_retry PASSED [ 38%]
tests/test_orchestrator.py::TestJobScheduler::test_run_job_wrapper_exponential_backoff PASSED [ 42%]
tests/test_orchestrator.py::TestJobScheduler::test_scheduler_loop_processes_ready_jobs PASSED [ 47%]
tests/test_orchestrator.py::TestJobScheduler::test_stop PASSED           [ 52%]
tests/test_orchestrator.py::TestJobScheduler::test_scheduler_loop_stops_when_event_set PASSED [ 57%]
tests/test_orchestrator_extra.py::TestOrchestratorExtra::test_job_from_dict PASSED [ 61%]
tests/test_orchestrator_extra.py::TestOrchestratorExtra::test_restore_session_scenarios PASSED [ 66%]
tests/test_orchestrator_extra.py::TestOrchestratorExtra::test_persist_session_error PASSED [ 71%]
tests/test_orchestrator_extra.py::TestOrchestratorExtra::test_write_heartbeat_error PASSED [ 76%]
tests/test_orchestrator_extra.py::TestOrchestratorExtra::test_proxy_rotation_strategies PASSED [ 80%]
tests/test_orchestrator_extra.py::TestOrchestratorExtra::test_run_job_wrapper_edge_cases PASSED [ 85%]
tests/test_orchestrator_extra.py::TestOrchestratorExtra::test_scheduler_loop_limits_and_errors FAILED [ 90%]
tests/test_orchestrator_extra.py::TestOrchestratorExtra::test_run_job_wrapper_unknown_faucet PASSED [ 95%]
C:\Python314\Lib\site-packages\_pytest\unraisableexception.py:33: RuntimeWarning: coroutine 'Event.wait' was never awaited
  gc.collect()
RuntimeWarning: Enable tracemalloc to get the object allocation traceback
tests/test_orchestrator_extra.py::TestOrchestratorExtra::test_proxy_fallbacks PASSED [100%]

================================== FAILURES ===================================
_________ TestOrchestratorExtra.test_scheduler_loop_limits_and_errors _________

self = <test_orchestrator_extra.TestOrchestratorExtra object at 0x00000217B4CCA8B0>
mock_settings = BotSettings(log_level='INFO', headless=True, captcha_provider='2captcha', twocaptcha_api_key='8861c78a551888d0d10a7f06...e=None, dutchy_password=None, accounts=[], enabled_faucets=['fire_faucet', 'cointiply', 'dutchy'], wallet_addresses={})
mock_browser_manager = <AsyncMock id='2300873497568'>

    @pytest.mark.asyncio
    async def test_scheduler_loop_limits_and_errors(self, mock_settings, mock_browser_manager):
        """Cover global/profile limits, domain delay, and health check failure."""
        scheduler = JobScheduler(mock_settings, mock_browser_manager)
    
        # 1. Health check failure (lines 330-331)
        mock_browser_manager.check_health = AsyncMock(return_value=False)
        scheduler.last_health_check_time = 0
        with patch("asyncio.wait_for", side_effect=asyncio.CancelledError):
            try: await scheduler.scheduler_loop()
            except asyncio.CancelledError: pass
            assert mock_browser_manager.restart.called
    
        # 2. Global limit (line 346)
        scheduler.queue.clear()
        mock_settings.max_concurrent_bots = 0
        job = Job(priority=1, next_run=time.time()-10, name="n", profile=AccountProfile(faucet="f", username="u", password="p"), faucet_type="test")
        scheduler.add_job(job)
        with patch("asyncio.wait_for", side_effect=asyncio.CancelledError):
             try: await scheduler.scheduler_loop()
             except asyncio.CancelledError: pass
             assert len(scheduler.running_jobs) == 0
    
        # 3. Profile limit (line 351)
        scheduler.queue.clear()
        mock_settings.max_concurrent_bots = 5
        mock_settings.max_concurrent_per_profile = 0
        scheduler.add_job(job)
        with patch("asyncio.wait_for", side_effect=asyncio.CancelledError):
             try: await scheduler.scheduler_loop()
             except asyncio.CancelledError: pass
             assert len(scheduler.running_jobs) == 0
    
        # 4. Domain rate limiting (lines 139, 356-358)
        fixed_time = 1000.0
        with patch("core.orchestrator.time.time", return_value=fixed_time):
            scheduler.queue.clear()
            scheduler.domain_last_access["test"] = fixed_time - 1.0 # 1s ago
            job.next_run = fixed_time - 10
            scheduler.add_job(job)
            with patch("asyncio.wait_for", side_effect=asyncio.CancelledError):
                try: await scheduler.scheduler_loop()
                except asyncio.CancelledError: pass
                # elapsed = 1, domain_delay = 44. job.next_run = 1000 + 44 = 1044
>               assert job.next_run == fixed_time + 44
E               AssertionError: assert 990.0 == (1000.0 + 44)
E                +  where 990.0 = Job(priority=1, next_run=990.0, name='n', profile=AccountProfile(faucet='f', username='u', password='p', proxy=None, proxy_pool=[], proxy_rotation_strategy='round_robin', residential_proxy=False, enabled=True), faucet_type='test', job_type='claim_wrapper', retry_count=0).next_run

tests\test_orchestrator_extra.py:198: AssertionError
------------------------------ Captured log call ------------------------------
WARNING  core.orchestrator:orchestrator.py:389 \U0001f6a8 Browser health check failed. Restarting...
=============================== tests coverage ================================
_______________ coverage: platform win32, python 3.14.2-final-0 _______________

Name                   Stmts   Miss  Cover   Missing
----------------------------------------------------
core\orchestrator.py     275     26    91%   139, 157-169, 184-203, 415-417, 441
----------------------------------------------------
TOTAL                    275     26    91%
=========================== short test summary info ===========================
FAILED tests/test_orchestrator_extra.py::TestOrchestratorExtra::test_scheduler_loop_limits_and_errors
======================== 1 failed, 20 passed in 1.63s =========================
